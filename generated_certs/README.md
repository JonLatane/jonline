# Generated Certs for Jonline
The best way to secure your Jonline distro is with Cert-Manager. There's also support manually using your own certs, and I've also documented using your own custom CA here, though this is of course not useful for most use cases of Jonline :)

## Use Cert-Manager (recommended)
These instructions should at least get you a lazy wildcard setup for a domain managed by DigitalOcean.

### Quick setup (DigitalOcean-only for now)
1. Point your DNS host (for instance, I use `jonline.io`), at the IP for your deployed `jonline` LoadBalancer instance. For the default Quick Start deploy, get it with: `kubectl describe service jonline -n jonline | grep 'LoadBalancer Ingress'`.
    * You need to be using DigitalOcean DNS for your domain and DigitalOcean Kubernetes Service (DOKS) to host.
2. Generate an API token with read+write access from [this DigitalOcean console page](https://cloud.digitalocean.com/account/api/tokens).
    * This, along with your email and the domain name, are all you need to get Cert-Manager up and running.
3. `make deploy_certmanager` to deploy CertManager to your cluster. (You can also follow [the official Cert-Manager docs](https://cert-manager.io/docs/installation/), but the Makefile just does what they say!)
4. `unset HISTFILE` in your terminal to prevent your API token from being stored in history.
5. `CERT_MANAGER_API_TOKEN=<api-token> CERT_MANAGER_DOMAIN=<your-domain.com> CERT_MANAGER_EMAIL=<your@email.com> make deploy_certmanager_credential`

Want to contribute to quick setup

### DIY with Cert-Manager
1. Point your DNS host (for instance, I use `be.jonline.io`), at the IP for your deployed `jonline` LoadBalancer instance. For the default Quick Start deploy, get it with: `kubectl describe service jonline -n jonline | grep 'LoadBalancer Ingress'`.
2. [Install Cert-Manager](https://cert-manager.io/docs/installation/).
    * Currently their page says: `kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml`.
3. Securely store your DNS provider's credentials.
    1. ***Disable history in your shell***.
        * For ZSH or Bash, simply `unset HISTFILE`.
    2. Generate and store your Cert-Manager-supported DNS provider's credentials.
        * DigitalOcean:
            * [Get an access token here](https://cloud.digitalocean.com/account/api/tokens).
            * Base64-encode it with `echo -n '<your DigitalOcean API token>' | base64`
            * Save it to K8s with `kubectl create secret generic digitalocean-dns --from-literal=access-token=<your Base64-encoded token> -n jonline`. (If you deployed to a namespace other than `jonline`, change it here.)
        * Other DNS providers: TBD. Search the web for "`<your provider> cert-manager dns01 wildcard`" for a start! The idea is to get your Cert-Manager/DNS provider to issue a cert for `yourdomain.com` and save it to the TLS secret `jonline-generated-tls` in the `jonline` namespace.
            * Contribute please üôèüèª Make a PR with your instructions here, a `backend/k8s/cert-manager.<your-provider>.template.yaml`, and new corresponding `make` targets for the next step!
4. Generate your Cert-Manager authority and certificate from the template included here, and apply them to your cluster.
    * DigitalOcean: `CERT_MANAGER_EMAIL=you@example.com CERT_MANAGER_DOMAIN=example.domain make deploy_certmanager_digitalocean_apply`. (If you deployed to a namespace other than `jonline`, prefix your command with `NAMESPACE=my_namespace`.)
5. Wait for your cert secret to be generated by Cert-Manager. In the default setup, it will appear in `get secret jonline-generated-tls -n jonline` once it's generated.
    * If something goes wrong, `kubectl describe certificate jonline-letsencrypt-cert -n jonline` to see details on what's going on with certificate generation.
6. `make deploy_be_restart` to use the Cert-Manager certificates.
7. You can validate your install with `make deploy_test_be`, similar to with an unsecured deployment. But now you must specify the domain. (By default, it targets your deployed external IP, and your domain cert isn't valid against an IP address.) So, simply do `TEST_GRPC_TARGET=example.domain:27707 make deploy_test_be`.

## Use certs from another CA
Perhaps you have a `server.pem` and `server.key` from your own CA. Make sure to specify the domain name you want the certs for (it can be a wildcard).

1. Ensure this directory has a `server.key` and your updated `server.pem` from your CA.
2. From the root of the repo, `make certs_server_store_in_k8s deploy_be_restart` to use your certs.
    * You can `make certs_delete_from_k8s deploy_be_restart` to switch back to non-TLS mode.

## Use your own custom CA
To deploy with your own custom CA (i.e. generate your own `ca.key` and overwrite the existing `ca.pem` with your own here):

1. Update `server.csr.conf` and `server.extfile.conf` to point to your domain. (If you ask me for a cert, I do this temporarily.)
2. From the root of the repo, `make certs_generate`.
    * This generates `ca.key`, `ca.pem`, `server.key`, and `server.pem`.
    * You can `make certs_ca_generate` or `make certs_server_generate` to generate either set of public/private keys independently. (If you ask me for a cert, I do the latter and send you the `server.key` and `server.pem`.)
3. Finally, `make certs_store_in_k8s` to store them, and `make deploy_be_restart` to restart your instance.
    * You can `make certs_ca_store_in_k8s` or `make certs_server_store_in_k8s` similarly.
4. You will need to provide both your `ca.pem` to end users if they use the official Jonline app. Alternatively, you could ship your own Jonline app with your own `ca.pem`.